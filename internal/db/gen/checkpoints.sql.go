// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: checkpoints.sql

package dbgen

import (
	"context"

	"github.com/jackc/pgx/v5/pgtype"
)

const extendRunClaim = `-- name: ExtendRunClaim :exec
UPDATE runs
SET claim_expires_at = now() + make_interval(secs => $2::int)
WHERE id = $1
`

type ExtendRunClaimParams struct {
	ID              pgtype.UUID `json:"id"`
	ExtendBySeconds int32       `json:"extend_by_seconds"`
}

func (q *Queries) ExtendRunClaim(ctx context.Context, arg ExtendRunClaimParams) error {
	_, err := q.db.Exec(ctx, extendRunClaim, arg.ID, arg.ExtendBySeconds)
	return err
}

const getCheckpoint = `-- name: GetCheckpoint :one
SELECT id, task_id, step_name, state, owner_run_id, created_at, updated_at FROM checkpoints
WHERE task_id = $1 AND step_name = $2
`

type GetCheckpointParams struct {
	TaskID   pgtype.UUID `json:"task_id"`
	StepName string      `json:"step_name"`
}

func (q *Queries) GetCheckpoint(ctx context.Context, arg GetCheckpointParams) (Checkpoint, error) {
	row := q.db.QueryRow(ctx, getCheckpoint, arg.TaskID, arg.StepName)
	var i Checkpoint
	err := row.Scan(
		&i.ID,
		&i.TaskID,
		&i.StepName,
		&i.State,
		&i.OwnerRunID,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const upsertCheckpoint = `-- name: UpsertCheckpoint :one
INSERT INTO checkpoints (task_id, step_name, state, owner_run_id)
VALUES ($1, $2, $3, $4)
ON CONFLICT (task_id, step_name) DO UPDATE
SET state = EXCLUDED.state,
    owner_run_id = EXCLUDED.owner_run_id,
    updated_at = now()
RETURNING id, task_id, step_name, state, owner_run_id, created_at, updated_at
`

type UpsertCheckpointParams struct {
	TaskID     pgtype.UUID `json:"task_id"`
	StepName   string      `json:"step_name"`
	State      []byte      `json:"state"`
	OwnerRunID pgtype.UUID `json:"owner_run_id"`
}

func (q *Queries) UpsertCheckpoint(ctx context.Context, arg UpsertCheckpointParams) (Checkpoint, error) {
	row := q.db.QueryRow(ctx, upsertCheckpoint,
		arg.TaskID,
		arg.StepName,
		arg.State,
		arg.OwnerRunID,
	)
	var i Checkpoint
	err := row.Scan(
		&i.ID,
		&i.TaskID,
		&i.StepName,
		&i.State,
		&i.OwnerRunID,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}
